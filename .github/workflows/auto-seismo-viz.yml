name: Automated seismological vizualisation 
on:
  # Schedule updates (each 15 minutes)
  schedule: [{cron: "*/15 * * * *"}]
  # Lines below let you run workflow manually and on each commit
  workflow_dispatch:
  push: {branches: ["master", "main"]}

jobs:
  Viz-EEW-MARN:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      
      - name: Install python dependencies
        run: |
          python -m pip install --requirement ${{ github.workspace }}/requirements.txt      
      - run: echo "üñ•Ô∏è The workflow is now ready to run ${{ github.repository }}."

      - name: Run the main program # add nseconds=9999999999 ndays=9 for full test
        id: seismoviz
        run: |
          python ${{ github.workspace }}/seismo-viz.py catalog_uri=USGS,${{ secrets.MARN_EEW_URL }} minmagnitude=4 longitude=-89 latitude=13.6 maxradius=2 debug=1   
      - if: steps.seismoviz.outcome == 'success'
        run: echo "üñ•Ô∏è The code in seismo-viz.py from ${{ github.repository }} exited successfully."
      
      - name: Check file existence
        id: check_files
        uses: andstor/file-existence-action@v1
        with:
          files: ${{ github.workspace }}"/data/*.png"

      - name: Archive all data and visuals in workspace
        if: steps.check_files.outputs.files_exists == 'true'
        uses: actions/upload-artifact@v3
        id: archive
        with:
          name: Data-and-Vizuals-UNA
          path: |
            ${{ github.workspace }}/data/*ml
            ${{ github.workspace }}/data/*seed
            ${{ github.workspace }}/*.png 
            ${{ github.workspace }}/*.mp4
          retention-days: 1
          if-no-files-found: error

      - name: Log success 
        if: steps.archive.outcome == 'success'
        run: echo "üéÅ The data and visuals from ${{ github.workspace }} are archived as an artifact for 1 days."
      - name: Send mail
        if: steps.archive.outcome == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          # Specify connection via URL (replaces server_address, server_port, secure,
          # username and password)
          #
          # Format:
          #
          #  * smtp://user:password@server:port
          #  * smtp+starttls://user:password@server:port
          #connection_url: ${{secrets.MAIL_CONNECTION}}
          # Required mail server address if not connection_url:
          server_address: smtp.gmail.com
          # Server port, default 25:
          server_port: 465
          # Optional whether this connection use TLS (default is true if server_port is 465)
          secure: true
          # Optional (recommended): mail server username:
          username: ${{secrets.MAIL_USERNAME}}
          # Optional (recommended) mail server password:
          password: ${{secrets.MAIL_PASSWORD}}
          # Required mail subject:
          subject: Github Actions job result
          # Required recipients' addresses:
          to: fmassin@sed.ethz.ch
          # Required sender full name (address can be skipped):
          from: ${{ github.repository }} # Luke Skywalker # <user@example.com>
          # Optional plain body:
          body: Event processing of ${{github.repository}} for MARN completed successfully!
          # Optional HTML body read from file:
          #html_body: file://README.html
          # Optional carbon copy recipients:
          #cc: kyloren@example.com,leia@example.com
          # Optional blind carbon copy recipients:
          #bcc: r2d2@example.com,hansolo@example.com
          # Optional recipient of the email response:
          #reply_to: luke@example.com
          # Optional Message ID this message is replying to:
          #in_reply_to: <random-luke@example.com>
          # Optional unsigned/invalid certificates allowance:
          ignore_cert: true
          # Optional converting Markdown to HTML (set content_type to text/html too):
          #convert_markdown: true
          # Optional attachments:
          attachments: ${{ github.workspace }}/*.png
          # Optional priority: 'high', 'normal' (default) or 'low'
          priority: high
      - run: echo "üçè This job's status is ${{ job.status }}."


# python ${{ github.workspace }}/seismo-viz.py catalog_uri='USGS',${{ secrets.UNA_EEW_URL }} stream_url=${{ secrets.UNA_EEW_URL }} minmagnitude=4 longitude=-84 latitude=9.5 maxradius=3 debug=1