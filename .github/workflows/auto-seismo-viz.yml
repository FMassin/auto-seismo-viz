name: Automated seismological vizualisation 
on:
  # Schedule updates (each hour)
  schedule: [{cron: "0 * * * *"}]
  # Lines below let you run workflow manually and on each commit
  workflow_dispatch:
  push: {branches: ["master", "main"]}

jobs:
  Viz-EEW-MARN:
    runs-on: ubuntu-latest
    steps:
      - name: üîé Check out repository code
        uses: actions/checkout@v3
      
      - name: üêß Install python dependencies
        run: |
          python -m pip install --requirement ${{ github.workspace }}/requirements.txt      

      - name: üí° Run the main program # add nseconds=9999999999 ndays=9 limit=2 for full test
        id: seismoviz
        run: |
          python ${{ github.workspace }}/seismo-viz.py catalog_uri=USGS,${{ secrets.MARN_EEW_URL }} minmagnitude=4 longitude=-89 latitude=13.6 maxradius=2 debug=1 
      
      - name: üñ•Ô∏è Check file existence
        id: check_files
        uses: andstor/file-existence-action@v1
        with:
          files: "data/*.png,data/*ml,data/*seed"

      - name: üéÅ Archive all data and visuals in workspace  as an artifact for 1 day
        if: steps.check_files.outputs.files_exists == 'true'
        uses: actions/upload-artifact@v3
        id: archive
        with:
          name: Data-and-Vizuals-MARN
          path: |
            ${{ github.workspace }}/data/*ml
            ${{ github.workspace }}/data/*seed
            ${{ github.workspace }}/data/*.png 
            ${{ github.workspace }}/data/*.mp4
          retention-days: 1
          if-no-files-found: error

      - name: üéâ Send mail
        if: steps.archive.outcome == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          # Specify connection via URL (replaces server_address, server_port, secure,
          # username and password)
          #
          # Format:
          #
          #  * smtp://user:password@server:port
          #  * smtp+starttls://user:password@server:port
          #connection_url: ${{secrets.MAIL_CONNECTION}}
          # Required mail server address if not connection_url:
          server_address: smtp.gmail.com
          # Server port, default 25:
          server_port: 465
          # Optional whether this connection use TLS (default is true if server_port is 465)
          secure: true
          # Optional (recommended): mail server username:
          username: ${{secrets.MAIL_USERNAME}}
          # Optional (recommended) mail server password:
          password: ${{secrets.MAIL_PASSWORD}}
          # Required mail subject:
          subject: Github Actions job result
          # Required recipients' addresses:
          to: ${{secrets.MAIL_TO}}
          # Required sender full name (address can be skipped):
          from: ${{ github.repository }} # Luke Skywalker # <user@example.com>
          # Optional plain body:
          body: |
            <!DOCTYPE html>
            <html>
              <head>
                <title>New event at MARN</title>
              </head>
            <body>                  
                  <p>Event processing of ${{github.repository}} for MARN completed successfully! </p>
                  <p>Results available for 1 day here ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} </p>
            </body>
            </html>
          # Optional HTML body read from file:
          #html_body: file://README.html
          # Optional carbon copy recipients:
          #cc: kyloren@example.com,leia@example.com
          # Optional blind carbon copy recipients:
          #bcc: r2d2@example.com,hansolo@example.com
          # Optional recipient of the email response:
          #reply_to: luke@example.com
          # Optional Message ID this message is replying to:
          #in_reply_to: <random-luke@example.com>
          # Optional unsigned/invalid certificates allowance:
          ignore_cert: true
          # Optional converting Markdown to HTML (set content_type to text/html too):
          convert_markdown: true
          # Optional attachments:
          attachments: ${{ github.workspace }}/data/*.png
          # Optional priority: 'high', 'normal' (default) or 'low'
          priority: high
      - run: echo "üçè This job's status is ${{ job.status }}."

  Viz-EEW-INETER:
    runs-on: ubuntu-latest
    steps:
      - name: üîé Check out repository code
        uses: actions/checkout@v3
      
      - name: üêß Install python dependencies
        run: |
          python -m pip install --requirement ${{ github.workspace }}/requirements.txt      

      - name: üí° Run the main program # add nseconds=9999999999 ndays=9 limit=2 for full test
        id: seismoviz
        run: |
          python ${{ github.workspace }}/seismo-viz.py catalog_uri=USGS,${{ secrets.INETER_EEW_URL }} inventory_url=${{ secrets.INETER_DATA_URL }} stream_url=${{ secrets.INETER_DATA_URL }}  minmagnitude=4 longitude=-86.5 latitude=12 maxradius=3 debug=1 
      
      - name: üñ•Ô∏è Check file existence
        id: check_files
        uses: andstor/file-existence-action@v1
        with:
          files: "data/*.png,data/*ml,data/*seed"

      - name: üéÅ Archive all data and visuals in workspace  as an artifact for 1 day
        if: steps.check_files.outputs.files_exists == 'true'
        uses: actions/upload-artifact@v3
        id: archive
        with:
          name: Data-and-Vizuals-INETER
          path: |
            ${{ github.workspace }}/data/*ml
            ${{ github.workspace }}/data/*seed
            ${{ github.workspace }}/data/*.png 
            ${{ github.workspace }}/data/*.mp4
          retention-days: 1
          if-no-files-found: error

      - name: üéâ Send mail
        if: steps.archive.outcome == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          # Specify connection via URL (replaces server_address, server_port, secure,
          # username and password)
          #
          # Format:
          #
          #  * smtp://user:password@server:port
          #  * smtp+starttls://user:password@server:port
          #connection_url: ${{secrets.MAIL_CONNECTION}}
          # Required mail server address if not connection_url:
          server_address: smtp.gmail.com
          # Server port, default 25:
          server_port: 465
          # Optional whether this connection use TLS (default is true if server_port is 465)
          secure: true
          # Optional (recommended): mail server username:
          username: ${{secrets.MAIL_USERNAME}}
          # Optional (recommended) mail server password:
          password: ${{secrets.MAIL_PASSWORD}}
          # Required mail subject:
          subject: Github Actions job result
          # Required recipients' addresses:
          to: ${{secrets.MAIL_TO}}
          # Required sender full name (address can be skipped):
          from: ${{ github.repository }} # Luke Skywalker # <user@example.com>
          # Optional plain body:
          body: |
            <!DOCTYPE html>
            <html>
              <head>
                <title>New event at INETER</title>
              </head>
            <body>                  
                  <p>Event processing of ${{github.repository}} for INETER completed successfully! </p>
                  <p>Results available for 1 day here ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} </p>
            </body>
            </html>
          # Optional HTML body read from file:
          #html_body: file://README.html
          # Optional carbon copy recipients:
          #cc: kyloren@example.com,leia@example.com
          # Optional blind carbon copy recipients:
          #bcc: r2d2@example.com,hansolo@example.com
          # Optional recipient of the email response:
          #reply_to: luke@example.com
          # Optional Message ID this message is replying to:
          #in_reply_to: <random-luke@example.com>
          # Optional unsigned/invalid certificates allowance:
          ignore_cert: true
          # Optional converting Markdown to HTML (set content_type to text/html too):
          convert_markdown: true
          # Optional attachments:
          attachments: ${{ github.workspace }}/data/*.png
          # Optional priority: 'high', 'normal' (default) or 'low'
          priority: high
      - run: echo "üçè This job's status is ${{ job.status }}."
    
  Viz-EEW-UNA:
    runs-on: ubuntu-latest
    steps:
      - name: üîé Check out repository code
        uses: actions/checkout@v3
      
      - name: üêß Install python dependencies
        run: |
          python -m pip install --requirement ${{ github.workspace }}/requirements.txt      

      - name: üí° Run the main program # add nseconds=9999999999 ndays=9 limit=2 for full test
        id: seismoviz
        run: |
          python ${{ github.workspace }}/seismo-viz.py catalog_uri=USGS,${{ secrets.UNA_EEW_URL }} minmagnitude=4 longitude=-84.2 latitude=9.5 maxradius=3 debug=1 nseconds=9999999999 ndays=9 limit=2
      
      - name: üñ•Ô∏è Check file existence
        id: check_files
        uses: andstor/file-existence-action@v1
        with:
          files: "data/*.png,data/*ml,data/*seed"

      - name: üéÅ Archive all data and visuals in workspace  as an artifact for 1 day
        if: steps.check_files.outputs.files_exists == 'true'
        uses: actions/upload-artifact@v3
        id: archive
        with:
          name: Data-and-Vizuals-UNA
          path: |
            ${{ github.workspace }}/data/*ml
            ${{ github.workspace }}/data/*seed
            ${{ github.workspace }}/data/*.png 
            ${{ github.workspace }}/data/*.mp4
          retention-days: 1
          if-no-files-found: error

      - name: üéâ Send email
        if: steps.archive.outcome == 'success'
        uses: devellany/send-mail@v1.0.2
        with:
          host: smtp.google.com
          account: ${{secrets.MAIL_USERNAME}}
          password: ${{secrets.MAIL_PASSWORD}}
          sender: ${{ github.repository }}
          from: ${{secrets.MAIL_USERNAME}}@gmail.com
          to: ${{secrets.MAIL_TO}}
          subject: New event at UNA
          body: |
            <!DOCTYPE html>
            <html>
              <head>
                <title>New event at UNA</title>
              </head>
            <body>                  
                  <p>Event processing of ${{github.repository}} for UNA completed successfully! </p>
                  <p>Results available for 1 day here ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} </p>
            </body>
            </html> 
          contentType: text/html
          attachments: '[{"path":"README.md"}]' #'[{"path":"${{ github.workspace }}/data/*.png"}]'

      - run: echo "üçè This job's status is ${{ job.status }}."
    


# python ${{ github.workspace }}/seismo-viz.py catalog_uri='USGS',${{ secrets.UNA_EEW_URL }} stream_url=${{ secrets.UNA_EEW_URL }} minmagnitude=4 longitude=-84 latitude=9.5 maxradius=3 debug=1